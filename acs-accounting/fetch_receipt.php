<?php    include 'config/config.php';     __check_login();    include 'connect.php';    $limit = '10';    $pageno = 1;    if($_POST['page'] > 1) {        $start = (($_POST['page'] - 1) * $limit);        $pageno = $_POST['page'];    } else {        $start = 0;    }    $sql_con_status = "IF(s.sts_id='STS001' ,1,0) AS sta_STS001,    IF(s.sts_id='STS002' AND r.re_typepay<>'',1,0) AS sta_STS002,    IF(s.sts_id='STS003' ,1,0) AS sta_STS003,    IF(s.sts_id='STS004' OR (s.sts_id='STS002' AND r.re_typepay='') ,1,0) AS sta_STS004,    IF(s.sts_id='STS004',1,0) AS sta_STS004_1,    IF(s.sts_id='STS002' AND r.re_typepay='' ,1,0) AS sta_STS004_2";        $str_sql = "SELECT * ,".$sql_con_status.",    CONCAT( re_u_create.user_firstname,'&nbsp;&nbsp;',re_u_create.user_surname) AS re_create_fullname,    CONCAT(re_u_edit.user_firstname,'&nbsp;&nbsp;',re_u_edit.user_surname) AS re_edit_fullname    FROM receipt_tb AS r     INNER JOIN company_tb AS c ON r.re_compid = c.comp_id     INNER JOIN customer_tb AS cust ON r.re_custid = cust.cust_id     INNER JOIN department_tb AS d ON r.re_depid = d.dep_id     INNER JOIN status_tb AS s ON r.re_stsid = s.sts_id    LEFT JOIN user_tb re_u_create ON re_u_create.user_id = r.re_userid_create    LEFT JOIN user_tb re_u_edit ON re_u_edit.user_id = r.re_userid_edit     WHERE re_compid = '". $_POST['queryComp'] ."' AND re_depid = '". $_POST['queryDep'] ."' ";                     if($_POST['querySearch'] != '') {        if($_POST['query'] != '') {            $str_sql .= ' AND '. $_POST['querySearch'] .' LIKE "%'.str_replace(' ', '%', $_POST['query']).'%" ';        }    }    $status = $_POST['queryStatus'];    if($status != ''){        $str_sql .= " HAVING sta_".$status."  = '1'";    }    $str_sql .= " ORDER BY re_no DESC ";    $filter_query = $str_sql . ' LIMIT '.$start.', '.$limit.'';                    // echo $filter_query;        $obj_query = mysqli_query($obj_con, $str_sql);    $total_data = mysqli_num_rows($obj_query);            $obj_query2 = mysqli_query($obj_con, $filter_query);    $obj_row2 = mysqli_fetch_array($obj_query2);    $total_filter_data = mysqli_num_rows($obj_query2);    $output = '<table class="table mb-0">                    <thead class="thead-light">                        <tr>                            <th width="15%">เลขที่ใบเสร็จรับเงิน</th>                            <th width="38%">รายละเอียด</th>                            <th width="13%" class="text-center">จำนวนเงิน</th>                            <th width="5%" class="text-center">ฝ่าย</th>                            <th width="12%" class="text-center">สถานะ</th>                            <th width="17%"></th>                        </tr>                    </thead>                    <tbody>';                        $html_modal_detail = "";                     if($total_data > 0) {        $i = 1;        $total = 0;        foreach($obj_query2 as $obj_row) {            $total = $total + $obj_row["re_grandtotal"];            if ($obj_row["re_bookno"] == '') {                $ReNo = $obj_row["re_no"];            } else {                $ReNo = $obj_row["re_bookno"].'/'.$obj_row["re_no"];            }            $pathFile = $obj_row["re_file"];            $str_sql_re = "SELECT *,$sql_con_status FROM receipt_tb r            LEFT JOIN status_tb s ON s.sts_id = r.re_stsid            WHERE re_id = '". $obj_row["re_id"] ."' ";            $obj_rs_re = mysqli_query($obj_con, $str_sql_re);            $obj_row_re = mysqli_fetch_array($obj_rs_re);            ;                    if ($obj_row_re["sta_STS004_1"] == '1' ) {                $bg = 'color: #F00; text-align: center; font-size: 15px; font-weight: 700;';                $text = 'รอชำระเงิน';            }if ($obj_row_re["sta_STS002"] == '1') {                $bg = 'color: #006600; text-align: center; font-size: 15px; font-weight: 700;';                $text = 'ชำระเงินแล้ว';            }if ($obj_row_re["sta_STS004_2"] == '1') {                $bg = 'color: #ffc107; text-align: center; font-size: 15px; font-weight: 700;';                $text = '<a class="btn btn-warning selectpay" id="' . $obj_row["re_id"] .'"data-toggle="modal" data-target="#exampleModalCenter" data-toggle="modal" data-target="#exampleModalCenter"">เลือกวิธีชำระเงิน</a>';                }if ($obj_row_re["sta_STS003"] == '1') {                $bg = 'color: red; text-align: center; font-size: 15px; font-weight: 700;';                $text = 'ยกเลิก';            }            if ($obj_row_re['re_refinvrcpt'] == 0) {                $str_sql_reinv = "SELECT *, $sql_con_status FROM receipt_tb AS r                                 INNER JOIN customer_tb AS cust ON r.re_custid = cust.cust_id                                 INNER JOIN company_tb AS c ON r.re_compid = c.comp_id                                 INNER JOIN department_tb AS d ON r.re_depid = d.dep_id                                 INNER JOIN invoice_rcpt_tb AS i ON r.re_id = i.invrcpt_reid                                 INNER JOIN status_tb AS s ON r.re_stsid = s.sts_id                                WHERE re_id = '". $obj_row["re_id"] ."'";                $obj_rs_reinv = mysqli_query($obj_con, $str_sql_reinv);                $obj_row_reinv = mysqli_fetch_array($obj_rs_reinv);                                             $desc1 = "";                $desc2 = "";                $desc3 = "";                $desc4 = "";                $desc5 = "";                $desc6 = "";                $desc7 = "";                $desc8 = "";                $projid = "";                if(!empty($obj_row_reinv["re_id"])){                    $desc1 = $obj_row_reinv["invrcpt_description1"];                    $desc2 = $obj_row_reinv["invrcpt_description2"];                    $desc3 = $obj_row_reinv["invrcpt_description3"];                    $desc4 = $obj_row_reinv["invrcpt_description4"];                    $desc5 = $obj_row_reinv["invrcpt_description5"];                    $desc6 = $obj_row_reinv["invrcpt_description6"];                    $desc7 = $obj_row_reinv["invrcpt_description7"];                    $desc8 = $obj_row_reinv["invrcpt_description8"];                    $projid = $obj_row_reinv['invrcpt_projid'];                }                $irID = $obj_row['re_invrcpt_id'];            } else {                $str_sql_reinv = "SELECT *, $sql_con_status  FROM receipt_tb AS r                                 INNER JOIN customer_tb AS cust ON r.re_custid = cust.cust_id                                 INNER JOIN company_tb AS c ON r.re_compid = c.comp_id                                 INNER JOIN department_tb AS d ON r.re_depid = d.dep_id                                 INNER JOIN status_tb AS s ON r.re_stsid = s.sts_id                                WHERE re_id = '". $obj_row["re_id"] ."'";                                                $obj_rs_reinv = mysqli_query($obj_con, $str_sql_reinv);                $obj_row_reinv = mysqli_fetch_array($obj_rs_reinv);                                $desc1 = $obj_row_reinv["re_description1"];                $desc2 = $obj_row_reinv["re_description2"];                $desc3 = $obj_row_reinv["re_description3"];                $desc4 = $obj_row_reinv["re_description4"];                $desc5 = $obj_row_reinv["re_description5"];                $desc6 = $obj_row_reinv["re_description6"];                $desc7 = $obj_row_reinv["re_description7"];                $desc8 = $obj_row_reinv["re_description8"];                $projid = '';                $irID = '';            }            $net = $obj_row['re_grandtotal'] + $obj_row['re_differencevat'] + $obj_row['re_differencegrandtotal'];                         //** PDF**//                $url_pdf = "export/receipt_pdf.php?ReID=".$obj_row["re_id"];            $html_modal_detail .= '                <div id="modalDetailReceiptPayment_'.$obj_row["re_id"].'" class="modal fade modal-detail" tabindex="-1" role="dialog" aria-hidden="true">                    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">                        <div class="modal-content">                            <div class="modal-header">                                <h3 class="modal-title py-2 '.(($obj_row_re["re_stsid"] == "STS003") ? " text-danger ": "").'"><i class="icofont-search-document"></i> เลขที่ใบเสร็จรับเงิน (เลขที่ '.$ReNo.' '.(($obj_row_re["re_stsid"] == "STS003") ? " #ยกเลิก ": "").')</h3>                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>                            </div>                            <div class="modal-body" >';                                                        if($obj_row_re["re_stsid"] == "STS003"){                                $html_modal_detail .= '<div class="row">                                    <div class="col-md-12">                                        <div class="alert alert-danger">                                            <b>สาเหตุที่ยกเลิก :  </b>' .$obj_row_re["re_note_cancel"].'<br>                                          </div>                                     </div>                                 </div>';                            }                                             $html_modal_detail .= '<div class="row">                                    <div class="col-md-12">                                         <object data="'.$url_pdf.'#toolbar=0&navpanes=0&scrollbar=0" type="application/pdf" width="100%" height="600" style="border: 1px solid"></object>                                     </div>                                 </div>                                 <div class="col-lg-12 px-1" style="border:2px dashed #d6d8db;margin-top:10px;padding:8px;font-size:13px">                                    <div class="col-md-12">                                         <h5><b><i class="icofont-ui-clock"></i> ประวัติการทำรายการ</b></h5>                                        <div class="row mt-2">                                              <div class="col-md-12 media"><b><i class="icofont-ui-add"></i> จัดทำเอกสาร โดย : </b> '.$obj_row["re_create_fullname"].' &nbsp;&nbsp;<b> วันเวลา : </b> '.__datetime($obj_row["re_createdate"]).'</div>                                               <div class="col-sm-12"><b><i class="icofont-ui-edit"></i> แก้ไขเอกสาร โดย : </b>                                                '. ((!empty($obj_row["re_userid_edit"])) ? $obj_row["re_edit_fullname"].' &nbsp;&nbsp;<b> วันเวลา :</b> '.__datetime($obj_row["re_editdate"]) : "-").'                                             </div>                                        </div>                                    </div>                                </div>                            </div>                        <div class="modal-footer">                            <button type="button" class="btn btn-dark" data-dismiss="modal" aria-hidden="true"><i class="icofont-close"></i> ปิด</button>                         </div>                    </div>                 </div>                </div>';             //**END MODAL PDF**//                         $output .= '<tr>';                            $output .= '<td>                                <p class="text-nowrap">'. $ReNo .'</p>                            </td>';                $output .= '                            <td>                                <div class="truncate">                                    <b>บริษัท : </b> '. $obj_row['cust_name'] .'<br>                                ';                                    if($obj_row_re['sta_STS003'] != 1) {                                        $output .= ' <b>รายการ  : </b> '. $obj_row["re_description1"] .' ';                                    }                                    else {                                        $output .= ' <b>หมายเหตุ : </b> '. $obj_row["re_note_cancel"] .' ';                                    }                $output .= '</div>                            </td>                                   <td class="text-right">                                <input type="text" class="form-control text-right numInvNet" value="'. number_format($net,2) .'" readonly>                                <input type="text" class="form-control text-right d-none numInvNet" value="'. $net .'" readonly>                            </td>                            <td class="text-center text-nowrap">                                '. $obj_row['dep_name'] .'                                <input type="text" class="form-control d-none" id="depName" value="'. $obj_row['dep_name'] .'" readonly>                            </td>                            <td class="text-center" style="'. $bg .'">                                '. $text .'                            </td>';                        $output .=  '<td>                            <button type="button" class="btn btn-primary form-control mb-1" name="view" title="ดู / View" data-toggle="modal" data-target="#modalDetailReceiptPayment_'.$obj_row["re_id"].'">                                <i class="icofont-eye-alt"></i>&nbsp;&nbsp;View                            </button>';                                            if ($obj_row['re_refinvrcpt'] == 1 && $obj_row_re["re_stsid"] != "STS003") {                        $output .= '<a href="receipt_copy.php?cid='. $obj_row['comp_id'] .'&dep='. $obj_row["re_depid"] .'&projid='. $projid .'&irID='. $irID .'&Reid='. $obj_row['re_id'] .'" class="btn btn-success form-control my-1" title="คัดลอก / Copy">                                        <i class="icofont-copy"></i>&nbsp;คัดลอก                                    </a><a href="export/receipt_pdf.php?ReID='. $obj_row["re_id"].'" class="btn btn-secondary form-control my-1 text-light" title="พิมพ์ / Print">                                        <i class="icofont-copy"></i>&nbsp;พิมพ์                                    </a>';                                } else {}                    if($obj_row_re["re_stsid"] != "STS003"){                        $output .= '<a data-toggle="modal" data-target="#exampleModalCenter" data-type3="'. $net .'" data-type2="'. $obj_row['re_invrcpt_id'] .'" data-type="'. $obj_row['re_no'] .'" id="'. $obj_row['re_id'] .'" class="btn btn-danger form-control mb-1 _cancel" type="button" title="ยกเลิก / Cancel">                                        <i class="icofont-close-circled"></i>&nbsp;ยกเลิก</a>';                                                                if($obj_row['re_invrcpt_id'] != ""){                            $output .= '                            <a href="invoice_rcpt_copy.php?cid='. $obj_row['re_compid'] .'&dep='.$obj_row["re_depid"].'&projid='.$obj_row_reinv['invrcpt_projid'].'&irID='.$obj_row['re_invrcpt_id'].'" class="btn btn-success form-control mb-1" type="button" title="คัดลอกใบแจ้งหนี้ / Copy Invoice">                            <i class="icofont-copy"></i>&nbsp;คัดลอกใบแจ้งหนี้                        </a>';                        }                                                $output .= '</td>                            <td class="d-none">';                    }                                            if($_POST['queryComp'] == 'C001') {                        $output .= '<input type="text" class="form-control d-none" name="viewComp" id="viewComp" value="ACS">';                                } else {                        $output .= '<input type="text" class="form-control d-none" name="viewComp" id="viewComp" value="'. $obj_row["dep_name"] .'">';                                }                $output .= '</td>                        </tr>                        <tr class="d-none">                            <td colspan="2"></td>                            <td class="text-right">                                <input type="text" class="form-control text-right" value="'. $total .'" readonly>                            </td>                            <td></td>                            <td></td>                            <td></td>                        </tr>';            $i++;        }    } else {        $output .= '</tbody>                    <tbody>                        <tr width="100%">                            <td colspan="6" align="center">ไม่มีข้อมูลใบเสร็จรับเงิน</td>                        </tr>                    </tbody>';    }            $total_links = ceil($total_data/$limit);    $previous_link = '';    $next_link = '';    $page_link = '';    $output .= '</table>                <div class="row mx-0 my-0">                    <div class="col-md-6 px-0 py-4">                        <ul class="pagination">';                            $page_array = array();    if($total_links > 4) {        if($pageno < 5) {            for($count = 1; $count <= 5; $count++) {                $page_array[] = $count;            }            $page_array[] = '...';            $page_array[] = $total_links;        } else {            $end_limit = $total_links - 5;            if($pageno > $end_limit) {                $page_array[] = 1;                $page_array[] = '...';                for($count = $end_limit; $count <= $total_links; $count++) {                    $page_array[] = $count;                }            } else {                $page_array[] = 1;                $page_array[] = '...';                for($count = $pageno - 1; $count <= $pageno + 1; $count++) {                    $page_array[] = $count;                }                $page_array[] = '...';                $page_array[] = $total_links;            }        }    } else {        for($count = 1; $count <= $total_links; $count++) {            $page_array[] = $count;        }    }    for($count = 0; $count < count($page_array); $count++) {        if($pageno == $page_array[$count]) {            $page_link .= '<li class="page-item active">                            <a class="page-link" href="#"> '.$page_array[$count].' <span class="sr-only">(current)</span></a>                        </li> ';            $previous_id = $page_array[$count] - 1;            if($previous_id > 0) {                $previous_link = '<li class="page-item">                                    <a class="page-link" href="javascript:void(0)" data-page_number="'.$previous_id.'">                                        <i class="icofont-rounded-left"></i>                                    </a>                                </li>';            } else {                $previous_link = '<li class="page-item disabled">                                    <a class="page-link" href="#">                                        <i class="icofont-rounded-left"></i>                                    </a>                                </li>';            }            $next_id = $page_array[$count] + 1;            if($next_id > $total_links) {                $next_link = '<li class="page-item disabled">                                <a class="page-link" href="#">                                    <i class="icofont-rounded-right"></i>                                </a>                            </li>';            } else {                $next_link = '<li class="page-item">                                <a class="page-link" href="javascript:void(0)" data-page_number="'.$next_id.'">                                    <i class="icofont-rounded-right"></i>                                </a>                            </li>';            }        } else {            if($page_array[$count] == '...') {                $page_link .= '<li class="page-item disabled">                                <a class="page-link" href="#">...</a>                            </li> ';            } else {                $page_link .= '<li class="page-item">                                <a class="page-link" href="javascript:void(0)" data-page_number="'.$page_array[$count].'">'.$page_array[$count].'</a>                            </li>';            }        }    }    $output .= $previous_link . $page_link . $next_link;            $output .= '</ul>                    </div>                    <div class="col-md-6 px-0 py-4 text-right">                        <b>จำนวนใบแจ้งหนี้ทั้งหมด : </b>                        <span id="numINV">'.$total_data.'</span>                        <input class="form-control d-none" type="number" id="numINV" value="'.$total_data.'">                    </div>                </div>';    echo $output;    echo $html_modal_detail;?>